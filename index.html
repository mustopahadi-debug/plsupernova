<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Pencarian Produk - Inventory Stock</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        #password-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
        }

        .password-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-container h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .password-container p {
            color: #666;
            margin-bottom: 30px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .password-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .password-btn:hover {
            transform: translateY(-2px);
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        #main-app {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 0.95em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.8em;
            font-weight: bold;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .upload-section h2 {
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
        }

        .file-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clear-btn {
            padding: 12px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .search-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .search-section h2 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .search-input-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 20px;
        }

        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f0f4ff;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .product-code {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
        }

        .product-name {
            font-size: 0.9em;
            color: #666;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 14px;
        }

        .sort-btn:hover {
            transform: translateY(-2px);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .results-container {
            display: grid;
            gap: 20px;
        }

        .results-count {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.2em;
        }

        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .product-header {
            margin-bottom: 15px;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sheet-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            width: fit-content;
        }

        .product-sku {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .product-name {
            font-size: 0.95em;
            color: #666;
            margin-top: 5px;
        }

        .product-code {
            font-size: 0.85em;
            color: #999;
        }

        .price-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .price-box {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .price-box.shopee {
            background: linear-gradient(135deg, #ee4d2d 0%, #ff6347 100%);
            color: white;
        }

        .price-box.tokped {
            background: linear-gradient(135deg, #03ac0e 0%, #32cd32 100%);
            color: white;
        }

        .price-label {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .price-value {
            font-size: 1.1em;
            font-weight: bold;
        }



        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }

        .stock-item {
            padding: 10px 8px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }

        .stock-item:hover {
            transform: scale(1.05);
        }

        .stock-item.has-stock {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stock-item.low-stock {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .stock-item.out-of-stock {
            background: #e0e0e0;
            color: #999;
        }

        .stock-label {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stock-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .total-stock-box {
            grid-column: 1 / -1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
            margin-top: 8px;
        }

        .total-stock-label {
            font-size: 0.85em;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .total-stock-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .other-warehouse-box {
            grid-column: 1 / -1;
            padding: 12px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
            margin-top: 5px;
        }

        .other-warehouse-label {
            font-size: 0.8em;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .other-warehouse-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.85em;
            }

            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card p {
                font-size: 1.5em;
            }

            .upload-section, .search-section {
                padding: 12px;
            }

            .file-input-container {
                flex-direction: column;
            }

            .file-input {
                min-width: 100%;
            }

            .stock-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 6px;
            }

            .stock-item {
                padding: 8px 5px;
            }

            .stock-label {
                font-size: 0.7em;
            }

            .stock-value {
                font-size: 1.1em;
            }

            .price-section {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .price-box {
                padding: 10px;
            }

            .price-value {
                font-size: 1em;
            }

            .product-card {
                padding: 12px;
            }

            .product-sku {
                font-size: 1.1em;
            }

            .product-name {
                font-size: 0.9em;
            }

            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-btn {
                width: 100%;
            }

            .total-stock-value {
                font-size: 1.6em;
            }

            .other-warehouse-value {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div id="password-screen">
        <div class="password-container">
            <h1>üîê Login</h1>
            <p>Masukkan password untuk mengakses sistem</p>
            <input type="password" id="password-input" class="password-input" placeholder="Password" autocomplete="off">
            <button onclick="checkPassword()" class="password-btn">Masuk</button>
            <div id="error-message" class="error-message">LAU SAPE EMPRUY</div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Konfirmasi</h2>
            <p style="margin-bottom: 30px; color: #666;">Apakah Anda yakin ingin menghapus semua data?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="confirmClear()">Ya, Hapus</button>
                <button class="modal-btn cancel" onclick="closeModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="main-app">
        <div class="container">
            <div class="header">
                <h1>üîç Pencarian Produk Inventory</h1>
                <p>Sistem Pencarian dan Monitoring Stok Produk</p>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3>üìÖ Update Terakhir</h3>
                    <p id="last-update">-</p>
                </div>
                <div class="stat-card">
                    <h3>üì¶ Total Produk</h3>
                    <p id="total-products">0</p>
                </div>
                <div class="stat-card">
                    <h3>üìä Total Sheet</h3>
                    <p id="total-sheets">0</p>
                </div>
            </div>

            <div class="upload-section">
                <h2>üì§ Upload Database Excel</h2>
                <div class="file-input-container">
                    <input type="file" id="excel-file" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                    <button onclick="uploadFile()" id="upload-btn" class="upload-btn" disabled>Upload File</button>
                    <button onclick="showClearModal()" class="clear-btn">Hapus Data</button>
                </div>
                <div id="status-message" class="status-message"></div>
            </div>

            <div class="search-section">
                <h2>üîé Cari Produk</h2>
                <div class="search-input-container">
                    <input 
                        type="text" 
                        id="search-input" 
                        class="search-input" 
                        placeholder="Ketik SKU, Nama Produk, Kode Barang, atau Spesifikasi..."
                        oninput="handleSearchInput()"
                        onkeydown="handleKeyDown(event)"
                    >
                    <span class="search-icon">üîç</span>
                    <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
                </div>
                <div class="sort-controls">
                    <span style="color: #666; font-weight: bold;">Urutkan:</span>
                    <button onclick="sortResults('default')" class="sort-btn active" id="sort-default">Default</button>
                    <button onclick="sortResults('stock-desc')" class="sort-btn" id="sort-stock-desc">üìä Stok Terbanyak</button>
                </div>
            </div>

            <div id="results-container" class="results-container">
                <div class="no-results">Ketik di kolom pencarian untuk mencari produk</div>
            </div>
        </div>
    </div>

    <script>
        const CORRECT_PASSWORD = 'hadibaik';
        let selectedFile = null;
        let productsData = [];
        let currentResults = [];
        let currentSort = 'default';
        let autocompleteIndex = -1;

        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        function checkPassword() {
            const inputPassword = document.getElementById('password-input').value;
            const errorMessage = document.getElementById('error-message');
            
            if (inputPassword === CORRECT_PASSWORD) {
                document.getElementById('password-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadFromStorage();
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        function showClearModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function confirmClear() {
            localStorage.removeItem('inventoryData');
            productsData = [];
            currentResults = [];
            document.getElementById('results-container').innerHTML = '<div class="no-results">Data telah dihapus. Upload file Excel untuk memulai.</div>';
            document.getElementById('last-update').textContent = '-';
            document.getElementById('total-products').textContent = '0';
            document.getElementById('total-sheets').textContent = '0';
            closeModal();
            showStatus('Data berhasil dihapus!', 'success');
        }

        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            document.getElementById('upload-btn').disabled = !selectedFile;
        }

        function uploadFile() {
            if (!selectedFile) {
                showStatus('Pilih file terlebih dahulu!', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    productsData = [];
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (jsonData.length < 5) return;
                        
                        const headerRow = jsonData[3];
                        
                        const warehouseColumns = {};
                        headerRow.forEach((header, idx) => {
                            if (header && typeof header === 'string') {
                                const cleanHeader = header.toString().trim();
                                if (cleanHeader.length <= 3 && /\d/.test(cleanHeader)) {
                                    warehouseColumns[cleanHeader] = idx;
                                }
                            }
                        });
                        
                        for (let i = 5; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || !row[0]) continue;
                            
                            const product = {
                                sheet: sheetName,
                                SKU: row[0] || '',
                                PRODUCT: row[1] || '',
                                KODEBARANG: row[2] || '',
                                SPESIFIKASI: row[3] || '',
                                M3: row[7] || '',
                                M4: row[8] || '',
                                CBM: row[9] || '',
                                CBB: row[10] || '',
                                TOTAL_STOCK: 0
                            };
                            
                            // Tambahkan stok dari semua gudang
                            let totalStock = 0;
                            Object.keys(warehouseColumns).forEach(wh => {
                                const colIdx = warehouseColumns[wh];
                                const stockValue = row[colIdx] || 0;
                                const stock = typeof stockValue === 'number' ? stockValue : 0;
                                product[wh] = stock;
                                totalStock += stock;
                            });
                            
                            product.TOTAL_STOCK = totalStock;
                            
                            // Hitung gudang lainnya (selain 1A, 3B, 5B, 4B, 6B, 3C, 6A)
                            const mainWarehouses = ['1A', '3B', '5B', '4B', '6B', '3C', '6A'];
                            let otherWarehouseStock = 0;
                            Object.keys(warehouseColumns).forEach(wh => {
                                if (!mainWarehouses.includes(wh)) {
                                    otherWarehouseStock += product[wh] || 0;
                                }
                            });
                            product.GUDANG_LAINNYA = otherWarehouseStock;
                            
                            productsData.push(product);
                        }
                    });
                    
                    const updateDate = new Date().toLocaleString('id-ID');
                    
                    const dataToStore = {
                        products: productsData,
                        lastUpdate: updateDate,
                        totalProducts: productsData.length,
                        totalSheets: workbook.SheetNames.length
                    };
                    
                    localStorage.setItem('inventoryData', JSON.stringify(dataToStore));
                    
                    updateStats(updateDate);
                    showStatus(`Berhasil upload ${productsData.length} produk dari ${workbook.SheetNames.length} sheet!`, 'success');
                    
                    document.getElementById('excel-file').value = '';
                    selectedFile = null;
                    document.getElementById('upload-btn').disabled = true;
                    
                } catch (error) {
                    console.error('Error reading file:', error);
                    showStatus('Error membaca file. Pastikan format Excel benar.', 'error');
                }
            };
            
            reader.readAsArrayBuffer(selectedFile);
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem('inventoryData');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    productsData = parsed.products || [];
                    document.getElementById('last-update').textContent = parsed.lastUpdate || '-';
                    document.getElementById('total-products').textContent = parsed.totalProducts || 0;
                    document.getElementById('total-sheets').textContent = parsed.totalSheets || 0;
                } else {
                    document.getElementById('last-update').textContent = '-';
                    document.getElementById('total-products').textContent = '0';
                    document.getElementById('total-sheets').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
            }
        }

        function updateStats(updateDate) {
            const uniqueSheets = [...new Set(productsData.map(p => p.sheet))];
            
            document.getElementById('last-update').textContent = updateDate;
            document.getElementById('total-products').textContent = productsData.length;
            document.getElementById('total-sheets').textContent = uniqueSheets.length;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function handleSearchInput() {
            const searchTerm = document.getElementById('search-input').value.trim();
            
            if (!searchTerm) {
                hideAutocomplete();
                document.getElementById('results-container').innerHTML = '<div class="no-results">Ketik di kolom pencarian untuk mencari produk</div>';
                return;
            }

            if (productsData.length === 0) {
                hideAutocomplete();
                return;
            }

            showAutocomplete(searchTerm);
        }

        function showAutocomplete(searchTerm) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            const searchLower = searchTerm.toLowerCase();
            
            const matches = productsData
                .filter(product => {
                    const searchableText = `${product.SKU} ${product.PRODUCT} ${product.KODEBARANG} ${product.SPESIFIKASI}`.toLowerCase();
                    return searchableText.includes(searchLower);
                })
                .slice(0, 10);
            
            if (matches.length === 0) {
                hideAutocomplete();
                return;
            }

            let html = '';
            matches.forEach((product, idx) => {
                html += `
                    <div class="autocomplete-item" onclick="selectAutocomplete(${idx})" data-index="${idx}">
                        <div class="product-code">${product.SKU} - ${product.PRODUCT}</div>
                        <div class="product-name">${product.SPESIFIKASI || product.KODEBARANG || ''}</div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
            autocompleteIndex = -1;
        }

        function hideAutocomplete() {
            document.getElementById('autocomplete-dropdown').style.display = 'none';
            autocompleteIndex = -1;
        }

        function selectAutocomplete(index) {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const matches = productsData.filter(product => {
                const searchableText = `${product.SKU} ${product.PRODUCT} ${product.KODEBARANG} ${product.SPESIFIKASI}`.toLowerCase();
                return searchableText.includes(searchTerm);
            }).slice(0, 10);
            
            if (matches[index]) {
                document.getElementById('search-input').value = matches[index].SKU;
                hideAutocomplete();
                searchProducts();
            }
        }

        function handleKeyDown(event) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');
            
            if (dropdown.style.display === 'none' && event.key === 'Enter') {
                searchProducts();
                return;
            }
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1);
                updateAutocompleteSelection(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                autocompleteIndex = Math.max(autocompleteIndex - 1, -1);
                updateAutocompleteSelection(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (autocompleteIndex >= 0) {
                    selectAutocomplete(autocompleteIndex);
                } else {
                    hideAutocomplete();
                    searchProducts();
                }
            } else if (event.key === 'Escape') {
                hideAutocomplete();
            }
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, idx) => {
                if (idx === autocompleteIndex) {
                    item.style.background = '#f0f4ff';
                } else {
                    item.style.background = 'white';
                }
            });
        }

        function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('results-container');

            if (!searchTerm) {
                resultsContainer.innerHTML = '<div class="no-results">Ketik di kolom pencarian untuk mencari produk</div>';
                return;
            }

            if (productsData.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Database kosong. Upload file Excel terlebih dahulu.</div>';
                return;
            }

            const results = productsData.filter(product => {
                const searchableText = `${product.SKU} ${product.PRODUCT} ${product.KODEBARANG} ${product.SPESIFIKASI}`.toLowerCase();
                return searchableText.includes(searchTerm);
            });

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Tidak ada produk yang cocok dengan pencarian Anda</div>';
                return;
            }

            currentResults = results;
            currentSort = 'default';
            updateSortButtons();
            displayResults(results);
        }

        function sortResults(sortType) {
            if (currentResults.length === 0) return;

            currentSort = sortType;
            updateSortButtons();

            let sortedResults = [...currentResults];

            if (sortType === 'stock-desc') {
                sortedResults.sort((a, b) => (b.TOTAL_STOCK || 0) - (a.TOTAL_STOCK || 0));
            }

            displayResults(sortedResults);
        }

        function updateSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`sort-${currentSort}`).classList.add('active');
        }

        function formatPrice(price) {
            if (!price || price === '' || price === '-') return '-';
            const numPrice = parseFloat(price);
            if (isNaN(numPrice)) return price;
            const finalPrice = numPrice * 1000;
            return 'Rp ' + finalPrice.toLocaleString('id-ID');
        }

        function displayResults(results) {
            const warehouses = ['1A', '3B', '5B', '4B', '6B', '3C', '6A', '4A'];
            
            let html = `<div class="results-count">Ditemukan ${results.length} produk</div>`;

            results.forEach(product => {
                html += `
                    <div class="product-card">
                        <div class="product-header">
                            <div class="product-info">
                                <span class="sheet-badge">${product.sheet}</span>
                                <span class="product-sku">${product.SKU}</span>
                                <div class="product-name">${product.SPESIFIKASI || '-'}</div>
                                <div class="product-code">üîñ ${product.KODEBARANG || '-'}</div>
                            </div>
                        </div>
                        <div class="price-section">
                            <div class="price-box shopee">
                                <div class="price-label">SHOPEE</div>
                                <div class="price-value">${formatPrice(product.M4)}</div>
                            </div>
                            <div class="price-box tokped">
                                <div class="price-label">TIKTOK/TOKOPEDIA</div>
                                <div class="price-value">${formatPrice(product.M3)}</div>
                            </div>
                        </div>
                        <div class="stock-grid">
                `;

                warehouses.forEach(wh => {
                    const stock = product[wh] || 0;
                    let stockClass = 'out-of-stock';
                    if (stock > 10) {
                        stockClass = 'has-stock';
                    } else if (stock > 0) {
                        stockClass = 'low-stock';
                    }
                    
                    html += `
                        <div class="stock-item ${stockClass}">
                            <div class="stock-label">${wh}</div>
                            <div class="stock-value">${stock}</div>
                        </div>
                    `;
                });

                html += `
                            <div class="other-warehouse-box">
                                <div class="other-warehouse-label">GUDANG LAINNYA</div>
                                <div class="other-warehouse-value">${product.GUDANG_LAINNYA || 0}</div>
                            </div>
                            <div class="total-stock-box">
                                <div class="total-stock-label">TOTAL STOK</div>
                                <div class="total-stock-value">${product.TOTAL_STOCK || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('results-container').innerHTML = html;
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-section')) {
                hideAutocomplete();
            }
        });
    </script>
</body>
</html>
